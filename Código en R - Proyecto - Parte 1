---
  #title: "Proyecto - Parte 1"
  ##author: "Mario A. Posadas"
  ---
  
  ## Librerías necesarias
  
  ```{r}
library(readxl)
library(dplyr)
library(janitor) 
library(DT)
library(stringi)
library(stringr)
library(arules)
library(tidyr)
library(purrr)
library(arulesViz)
library(ggplot2)
library(dplyr)
```

## Repositorio

### Fuente 1 - Hechos delictivos INE

```{r}
ruta <- "D:/Desktop/Maestría Ciencias de la Computación/IV TRIMESTRE/Introducción a la minería de datos/Proyecto/Repositorio/FUENTE1-INE-HECHOS-DELICTIVOS/DELITOS-CONTRA-LIBERTAD-PNC"
archivos <- list.files(path = ruta, pattern = "\\.xlsx$", full.names = TRUE)

```

###### Renombramiento de columnas que tengan en común Año

```{r}
leer_con_prefijo <- function(archivo) {
  df <- read_excel(archivo, skip = 2)
  df <- clean_names(df)  # Limpia nombres 
  if (!"ano" %in% names(df)) {
    names(df)[1] <- "ano"
  }
  prefijo <- tools::file_path_sans_ext(basename(archivo))
  otras_cols <- setdiff(names(df), "ano")
  names(df)[names(df) != "ano"] <- paste0(prefijo, "_", otras_cols)
  return(df)
}

```

###### Lectura de todos los archivos

```{r}
lista_datos <- lapply(archivos, leer_con_prefijo)
```

###### Unión por año

```{r}
datos_fuente1 <- Reduce(function(x, y) full_join(x, y, by = "ano"), lista_datos)
```

###### Verificación de archivos cargados

```{r}
glimpse(datos_fuente1)
```

###### Vista resumida en tabla de la información cargada

```{r}
ver_tabla <- function(data, filas = 10) {
  if (!requireNamespace("DT", quietly = TRUE)) {
    install.packages("DT")
  }
  library(DT)
  
  datatable(
    data,
    options = list(pageLength = filas, scrollX = TRUE),
    rownames = FALSE
  )
}
ver_tabla(datos_fuente1)
```

### Fuente 2 - Médico Legal INACIF

```{r}
# Ruta del directorio FUENTE2
ruta_fuente2 <- "D:/Desktop/Maestría Ciencias de la Computación/IV TRIMESTRE/Introducción a la minería de datos/Proyecto/Repositorio/FUENTE2-MEDICO-LEGAL-INACIF"

# Listar todos los archivos Excel
archivos_fuente2 <- list.files(path = ruta_fuente2, pattern = "\\.xlsx$", full.names = TRUE)
```

###### Limpieza y orden de la información

```{r}
# Si existieran datos por limpiar:
leer_fuente2 <- function(archivo) {
  df <- read_excel(archivo)
  df <- clean_names(df)  # Limpia nombres: sin tildes, espacios, mayúsculas
  
  # Si el archivo tiene eva_ml y sexo_per_eva, renombrarlos para unificar:
  if ("eva_ml" %in% names(df)) {
    df <- df %>% rename(clasif_eval = eva_ml)
  }
  if ("sexo_per_eva" %in% names(df)) {
    df <- df %>% rename(sexo_per = sexo_per_eva)
  }
  
  # Agregar columna con nombre del archivo
  df <- df %>% mutate(fuente = basename(archivo))
  
  return(df)
}

# Leer y apilar todos los archivos
datos_fuente2 <- bind_rows(lapply(archivos_fuente2, leer_fuente2))
```

###### Verificar estructura

```{r}
glimpse(datos_fuente2)
```

### Fuente 3 - Médico Necropcia INACIF

```{r}
# Ruta del directorio FUENTE3
ruta_fuente3 <- "D:/Desktop/Maestría Ciencias de la Computación/IV TRIMESTRE/Introducción a la minería de datos/Proyecto/Repositorio/FUENTE3-MEDICO-NECROPCIA-INACIF"

# Listar todos los archivos Excel
archivos_fuente3 <- list.files(path = ruta_fuente3, pattern = "\\.xlsx$", full.names = TRUE)

# Extraer nombres de columna por archivo
nombres_df <- lapply(archivos_fuente3, function(archivo) {
  nombres <- names(read_excel(archivo, n_max = 0))
  data.frame(
    archivo = basename(archivo),
    columna = nombres,
    stringsAsFactors = FALSE
  )
}) %>% bind_rows()

# Mostrar como tabla
print(nombres_df)

# Función para normalizar nombres de columna
normalizar_nombres <- function(nombres) {
  nombres %>%
    stri_trans_general("Latin-ASCII") %>%       # Elimina tildes
    str_replace_all("ñ", "n") %>%               # Reemplaza ñ por n
    str_replace_all("[\\p{P}-[_]]+", "") %>%    # Elimina puntuación excepto _
    str_replace_all("\\s+", "_") %>%            # Reemplaza espacios por _
    tolower()                                   # Minúsculas
}

# Función para renombrar columnas específicas
unificar_nombres <- function(nombres) {
  reemplazos <- c(
    "causa_muerte" = "eva_mn",
    "ano_ing" = "ano_ocu",
    "mes_ing" = "mes_ocu",
    "dia_ing" = "dia_ocu",
    "dia_sem_ing" = "dia_sem_ocu",
    "sexo_per" = "sexo_per_eva"
  )
  ifelse(nombres %in% names(reemplazos), reemplazos[nombres], nombres)
}

```



###### Dentro de esta fuente se ha indentificado que en el año 2024 existe una columna 'g_edad_ninez_adolescencia', de la cual no se tienen registros de años anterior, por lo cual se excluye al no ser data significativa para comparación.

```{r}
# Función para leer y normalizar columnas, excluyendo g_edad_ninez_adolescencia
leer_fuente3 <- function(archivo) {
  df <- read_excel(archivo)
  
  nombres_originales <- names(df)
  nombres_normalizados <- normalizar_nombres(nombres_originales)
  
  # Asignar nombres normalizados temporalmente
  names(df) <- nombres_normalizados
  
  # Excluir columna ya normalizada
  if ("g_edad_ninez_adolescencia" %in% names(df)) {
    df <- df %>% select(-g_edad_ninez_adolescencia)
    nombres_normalizados <- names(df)  # Actualizar nombres tras exclusión
  }
  
  
  # Renombrar según mapeo
  nombres_unificados <- unificar_nombres(nombres_normalizados)
  
  # Verificar duplicados post-renombramiento
  if (any(duplicated(nombres_unificados))) {
    duplicados <- nombres_unificados[duplicated(nombres_unificados)]
    warning("Columnas duplicadas tras renombrar en ", basename(archivo), ": ",
            paste(duplicados, collapse = ", "))
    
    nombres_unificados <- make.unique(nombres_unificados, sep = "_dup")
  }
  
  names(df) <- nombres_unificados
  
  # Agregar columna de procedencia
  df <- df %>% mutate(fuente = basename(archivo))
  
  return(df)
}

# Leer todos los archivos
lista_fuente3 <- lapply(archivos_fuente3, leer_fuente3)

# Unificar columnas presentes en al menos uno de los archivos
todas_columnas <- unique(unlist(lapply(lista_fuente3, names)))

# Alinear columnas en todos los dataframes
alinear_columnas <- function(df, columnas_objetivo) {
  faltantes <- setdiff(columnas_objetivo, names(df))
  for (col in faltantes) {
    df[[col]] <- NA
  }
  df <- df[, columnas_objetivo]
  return(df)
}

# Aplicar alineación
datos_fuente3 <- bind_rows(lapply(lista_fuente3, function(df) alinear_columnas(df, todas_columnas)))

# Verificar estructura final
glimpse(datos_fuente3)
```


### Fuente 4 - Médico Exhumación INACIF

```{r}
# Ruta del directorio FUENTE4
ruta_fuente4 <- "D:/Desktop/Maestría Ciencias de la Computación/IV TRIMESTRE/Introducción a la minería de datos/Proyecto/Repositorio/FUENTE4-MEDICO-EXHUMACION-INACIF"

# Listar todos los archivos Excel
archivos_fuente4 <- list.files(path = ruta_fuente4, pattern = "\\.xlsx$", full.names = TRUE)

# Extraer nombres de columna por archivo
titulos_fuente4 <- lapply(archivos_fuente4, function(archivo) {
  nombres <- names(read_excel(archivo, n_max = 0))  # Solo lee encabezados
  data.frame(
    archivo = basename(archivo),
    columna = nombres,
    stringsAsFactors = FALSE
  )
}) %>% bind_rows()

# Mostrar resultados de nombres de columnas
titulos_fuente4 %>%
  group_by(archivo) %>%
  summarise(titulos = paste(columna, collapse = ", ")) %>%
  print(width = Inf)


# Función para normalizar nombres de columna
normalizar_nombres <- function(nombres) {
  nombres %>%
    stri_trans_general("Latin-ASCII") %>%       # Elimina tildes
    str_replace_all("ñ", "n") %>%               # Reemplaza ñ por n
    str_replace_all("[\\p{P}-[_]]+", "") %>%    # Elimina puntuación excepto _
    str_replace_all("\\s+", "_") %>%            # Reemplaza espacios por _
    tolower()
}

# Leer encabezados normalizados por archivo
encabezados_fuente4 <- lapply(archivos_fuente4, function(archivo) {
  nombres <- names(read_excel(archivo, n_max = 0))
  normalizados <- normalizar_nombres(nombres)
  return(normalizados)
})

# Detectar columnas comunes entre todos los archivos
columnas_comunes <- Reduce(intersect, encabezados_fuente4)

# Para los años 2019 y 2024 existen columnas adicionales que no coinciden con el formato del resto, se incluyen solo las que encuentre en común

# Función para leer solo columnas comunes
leer_fuente4 <- function(archivo, columnas_objetivo) {
  df <- read_excel(archivo)
  names(df) <- normalizar_nombres(names(df))
  df <- df %>% select(any_of(columnas_objetivo))
  df <- df %>% mutate(fuente = basename(archivo))
  return(df)
}

# Leer todos los archivos con columnas comunes
datos_fuente4 <- lapply(archivos_fuente4, leer_fuente4, columnas_objetivo = columnas_comunes) %>%
  bind_rows()

# Verificar estructura final
glimpse(datos_fuente4)

```

## Reglas de asociación Apriori

###### Primero se estandariza el título de año de las fuentes para tener misma referencia
```{r}
estandarizar_año <- function(df) {
  posibles_nombres <- c("ano", "Año", "año", "ano_ocu", "ANIO", "anio", "Ano", "ANO")
  nombre_encontrado <- intersect(posibles_nombres, names(df))
  
  if (length(nombre_encontrado) == 1) {
    df <- df %>% rename(Año = all_of(nombre_encontrado))
  } else if (length(nombre_encontrado) > 1) {
    warning("Se encontraron múltiples columnas de año: ", paste(nombre_encontrado, collapse = ", "))
    df <- df %>% rename(Año = all_of(nombre_encontrado[1]))
  } else {
    stop("No se encontró ninguna columna de año reconocible.")
  }
  
  return(df)
}

#Aplicar a todas las fuentes
datos_fuente1 <- estandarizar_año(datos_fuente1)
datos_fuente2 <- estandarizar_año(datos_fuente2)
datos_fuente3 <- estandarizar_año(datos_fuente3)
datos_fuente4 <- estandarizar_año(datos_fuente4)
```

###### Asociación con fuente INACIF Médico Legal

```{r}

# Se crea una copia limpia para no modificar el original
datos_f2_apriori <- datos_fuente2

# Eliminar columnas que no aportan al análisis 
datos_f2_apriori <- datos_f2_apriori %>%
  select( -fuente, -g_edad_60ymas, -menor_mayor, -edad_per, -edad_quinquenales) # Todas las relacionadas a edad son redundantes, fuente había sido colocado para propósito de visualización al importar)

# Convertir todas las columnas a factor (cada columna es un atributo categórico)
datos_f2_apriori[] <- lapply(datos_f2_apriori, as.factor)

# Convertir a formato de transacciones para 'arules'
transacciones_f2 <- as(datos_f2_apriori, "transactions")

# Ver resumen de las transacciones
summary(transacciones_f2)

# Aplicar el algoritmo Apriori
reglas_f2 <- apriori(
  transacciones_f2,
  parameter = list(support = 0.1, confidence = 0.8, minlen = 2)
)

# Ver resultados
inspect(head(sort(reglas_f2, by = "lift"), 20))

```

###### Asociación con fuente de servicios médicos de necropcias INACIF

```{r}
# Se crear una copia limpia para no modificar el original
datos_f3_apriori <- datos_fuente3

# Eliminar columnas que no aportan al análisis o son irrelevantes
datos_f3_apriori <- datos_f3_apriori %>%
  select(-fuente, -edad_per, -edad_quinquenales, -g_edad_60ymas, -menor_mayor) # Todas las relacionadas a edad son redundantes, fuente había sido colocado para propósito de visualización al importar)

# Convertir todas las columnas a factor (atributos categóricos)
datos_f3_apriori[] <- lapply(datos_f3_apriori, as.factor)

# Convertir a formato de transacciones para 'arules'
transacciones_f3 <- as(datos_f3_apriori, "transactions")

# Ver resumen de las transacciones
summary(transacciones_f3)

# Aplicar algoritmo Apriori
reglas_f3 <- apriori(
  transacciones_f3,
  parameter = list(support = 0.2, confidence = 0.8, minlen = 2)
)

# Ver primeras reglas ordenadas por lift
inspect(head(sort(reglas_f3, by = "lift"), 10))

# Visualizar reglas
library(arulesViz)
plot(reglas_f3, method = "graph", engine = "htmlwidget")


```

###### Asociación con fuente de servicios médicos de exhumación INACIF

```{r}
# Se crea una copia limpia para no modificar el original
datos_f4_apriori <- datos_fuente4

# Eliminar columnas que no aportan al análisis o son numéricas
datos_f4_apriori <- datos_f4_apriori %>%
  select( -fuente, -num_corre)

# Convirtiendo todas las columnas a factor 
datos_f4_apriori[] <- lapply(datos_f4_apriori, as.factor)

# Convertir a formato de transacciones para 'arules'
transacciones_f4 <- as(datos_f4_apriori, "transactions")

# Ver resumen de las transacciones
summary(transacciones_f4)

# Aplicar algoritmo Apriori
reglas_f4 <- apriori(
  transacciones_f4,
  parameter = list(support = 0.2, confidence = 0.8, minlen = 2)
)

# Ver las 10 reglas principales ordenadas por lift
inspect(head(sort(reglas_f4, by = "lift"), 10))

# Visualización de las reglas en forma de grafo interactivo
plot(reglas_f4, method = "graph", engine = "htmlwidget")


```

## ALGORITMO FP-GROWTH

###### Analizando los hechos delictivos del INE
```{r}
##F1
campos_fp1 <- c("Año", "DELITOS-CONTRA-LIBERTAD-Por  tipo_total", "DELITOS-CONTRA-LIBERTAD-Por  tipo_desaparecidos", "DELITOS-CONTRA-LIBERTAD-Por  tipo_secuestros",
                "DELITOS-CONTRA-LIBERTAD-Por grupo_total","DELITOS-CONTRA-LIBERTAD-Por grupo_menor_de_15","DELITOS-CONTRA-LIBERTAD-Por grupo_x15_19","DELITOS-CONTRA-LIBERTAD-Por grupo_x20_24","DELITOS-CONTRA-LIBERTAD-Por grupo_x25_29","DELITOS-CONTRA-LIBERTAD-Por grupo_x30_34","DELITOS-CONTRA-LIBERTAD-Por grupo_x35_39",
                "DELITOS-CONTRA-LIBERTAD-Por grupo_x40_44","DELITOS-CONTRA-LIBERTAD-Por grupo_x45_49","DELITOS-CONTRA-LIBERTAD-Por grupo_x50_54","DELITOS-CONTRA-LIBERTAD-Por grupo_x55_59","DELITOS-CONTRA-LIBERTAD-Por grupo_x60_y_mas",
                "DELITOS-CONTRA-LIBERTAD-Por sexo_total","DELITOS-CONTRA-LIBERTAD-Por sexo_hombre","DELITOS-CONTRA-LIBERTAD-Por sexo_mujer")
# Seleccionar columnas relevantes
data_fp1 <- datos_fuente1[, campos_fp1]


# Asegurarse de que todos los campos sean texto
data_fp1[] <- lapply(data_fp1, as.character)

# Aplicar FP-Growth
reglas_fp1 <- fim4r(data_fp1, method = "fpgrowth", target = "rules", supp = 0.2, conf = 0.5)

# Convertir a data.frame para inspección
rf1 <- as(reglas_fp1, "data.frame")
head(rf1)
```

###### Algoritmo aplicado a Médico Legal INACIF


```{r}

##F2
campos_fp2 <- c("Año", "mes_ocu", "dia_ocu", "dia_sem_ocu", "depto_ocu", "edad_per", "g_edad_60ymas", "g_edad_80ymas", "edad_quinquenales", "menor_mayor", "sexo_per", "clasif_eval")

# Seleccionar columnas relevantes
data_fp2 <- datos_fuente2[, campos_fp2]

# Asegurarse de que todos los campos sean texto
data_fp2[] <- lapply(data_fp2, as.character)

# Aplicar FP-Growth
reglas_fp2 <- fim4r(data_fp2, method = "fpgrowth", target = "rules", supp = 0.2, conf = 0.5)

# Convertir a data.frame para inspección
rf2 <- as(reglas_fp2, "data.frame")
head(rf2)

```

###### Algoritmo para servicios médicos de necropcias INACIF 
```{r}
##F3
names(datos_fuente3)
campos_fp3 <- c("Año", "mes_ocu", "dia_ocu", "dia_sem_ocu", "depto_ocu", "mupio_ocu", "edad_per", "g_edad_60ymas", "g_edad_80ymas", "edad_quinquenales", "menor_mayor", "sexo_per_eva", "eva_mn")

# Seleccionar columnas relevantes
data_fp3 <- datos_fuente3[, campos_fp3]

# Asegurarse de que todos los campos sean texto
data_fp3[] <- lapply(data_fp3, as.character)

# Aplicar FP-Growth
reglas_fp3 <- fim4r(data_fp3, method = "fpgrowth", target = "rules", supp = 0.2, conf = 0.5)

# Convertir a data.frame para inspección
rf3 <- as(reglas_fp3, "data.frame")
head(rf3)

```

###### Algoritmo para servicios médicos de exhumación INACIF

```{r}

##F4
names(datos_fuente4)
campos_fp4 <- c("Año", "mes_ocu", "dia_ocu", "dia_sem_ocu", "depto_ocu")

# Seleccionar columnas relevantes
data_fp4 <- datos_fuente4[, campos_fp4]

# Asegurarse de que todos los campos sean texto
data_fp4[] <- lapply(data_fp4, as.character)

# Aplicar FP-Growth
reglas_fp4 <- fim4r(data_fp4, method = "fpgrowth", target = "rules", supp = 0.2, conf = 0.5)

# Convertir a data.frame para inspección
rf4 <- as(reglas_fp4, "data.frame")
head(rf4)
```

## Análisis de clústers (K-means)

```{r}
library(dplyr)
library(ggplot2)

# Seleccionar variables relevantes
campos_fp2 <- c("Año", "mes_ocu", "dia_ocu", "dia_sem_ocu", "depto_ocu",
                "edad_per", "g_edad_60ymas", "g_edad_80ymas",
                "edad_quinquenales", "menor_mayor", "sexo_per", "clasif_eval")

data_fp2 <- datos_fuente2[, campos_fp2]

# Convertir caracteres/factores a numéricos
data_fp2[] <- lapply(data_fp2, function(x) {
  if (is.character(x) || is.factor(x)) {
    as.numeric(as.factor(x))
  } else {
    as.numeric(x)
  }
})

# Limpiar datos
data_fp2 <- data_fp2 %>%
  filter(clasif_eval < 100) %>%  # eliminar valores anómalos tipo 998
  na.omit()

# Escalar variables para clustering
campos_cluster <- c("dia_sem_ocu", "depto_ocu", "mes_ocu", "Año", "dia_ocu", "clasif_eval")
data_fp2_scaled <- scale(data_fp2[, campos_cluster])

# Aplicar K-Means con 3 clústeres
set.seed(123)
km3_fp2 <- kmeans(data_fp2_scaled, centers = 3)
data_fp2$cluster <- factor(km3_fp2$cluster)

# Centroides originales
centroides_fp2 <- as.data.frame(km3_fp2$centers)
centroides_fp2$cluster <- factor(1:3)

# Visualización — Día de la semana vs clasificación sin agrupar
ggplot(data_fp2, aes(x = dia_sem_ocu, y = clasif_eval, color = cluster)) +
  geom_jitter(alpha = 0.6, size = 2, width = 0.3) +
  labs(title = "Día de la semana vs tipo de evaluación (sin agrupar)",
       x = "Día de la semana", y = "Clasificación Médico Legal") +
  theme_minimal()

```
###### Hay mayor concentración entre miércoles a sábado, seguramente está relacionado con lo laboral, transporte y actividades sociales.


######Sub segmentación del clúster anterior para analizar clasificación de evaluación entre 21 y 30

```{r}
# Filtrar casos con clasificación médico legal entre 21 y 30 y día de ocurrencia igual a 3
tabla_21_30_dia3 <- datos_fuente2 %>%
  filter(clasif_eval >= 21 & clasif_eval <= 30,
         dia_ocu == 3)

# Ver primeras filas
head(tabla_21_30_dia3)

# Ver resumen por tipo de evaluación
tabla_21_30_dia3 %>%
  count(clasif_eval, sort = TRUE)
##Por alguna razón los días miércoles son más frecuentes la atención por lesiones

# Paso 1: Filtrar los datos
tabla_filtrada <- datos_fuente2 %>%
  filter(clasif_eval >= 21 & clasif_eval <= 30,
         dia_ocu == 3,
         edad_quinquenales < 900,
         depto_ocu < 900)  # Excluye valores ignorados

# Paso 2: Resumen por tipo de evaluación, departamento y grupo de edad
resumen_eval <- tabla_filtrada %>%
  group_by(clasif_eval, depto_ocu, edad_quinquenales) %>%
  summarise(casos = n(), .groups = "drop") %>%
  arrange(desc(casos))

# Paso 3: Ver primeras filas
head(resumen_eval, 20)
##La edad es ignorada en la mayoría de casos pero ciertamente el departamento de mayor atención es Guatemala. El siguiente grupo de edad con lesión está entre 35-39, lo cual sugiere que son personas económicamente activas y pudiese estar relacionado a temas laborales o actividades sociales.

# Visualización alternativa 2: Mes vs Departamento
ggplot(data_fp2, aes(x = mes_ocu, y = depto_ocu, color = cluster)) +
  geom_point(alpha = 0.7, size = 3) +
  stat_ellipse(type = "norm", level = 0.95, aes(fill = cluster), geom = "polygon", alpha = 0.2) +
  geom_point(data = centroides_fp2, aes(x = mes_ocu, y = depto_ocu),
             color = "black", shape = 17, size = 5, stroke = 1.5) +
  labs(title = "Clústeres FP2: Mes vs Departamento",
       x = "Mes de ocurrencia", y = "Departamento") +
  theme_minimal()

# Visualización alternativa 3: Histograma por clúster
ggplot(data_fp2, aes(x = clasif_eval, fill = cluster)) +
  geom_histogram(binwidth = 1, position = "dodge") +
  labs(title = "Distribución de clasif_eval por clúster",
       x = "Evaluación Médico Legal", y = "Frecuencia") +
  theme_minimal()

# Alternativa 4
campos_cluster <- c("clasif_eval", "depto_ocu")
data_clinico_geo <- datos_fuente2[, campos_cluster]

# Convertir a numérico si es necesario
data_clinico_geo[] <- lapply(data_clinico_geo, function(x) {
  if (is.character(x) || is.factor(x)) {
    as.numeric(as.factor(x))
  } else {
    as.numeric(x)
  }
})

data_clinico_geo <- data_clinico_geo %>%
  filter(clasif_eval < 900, depto_ocu < 900) %>%
  na.omit()

# Escalar variables
data_scaled <- scale(data_clinico_geo)

# Aplicar K-Means con 3 clústeres
set.seed(123)
km3_eval_depto <- kmeans(data_scaled, centers = 3)
data_clinico_geo$cluster <- factor(km3_eval_depto$cluster)

# Centroides
centroides <- as.data.frame(km3_eval_depto$centers)
centroides$cluster <- factor(1:3)


ggplot(data_clinico_geo, aes(x = clasif_eval, y = depto_ocu, color = cluster)) +
  geom_jitter(alpha = 0.6, size = 2, width = 0.3, height = 0.3) +
  stat_ellipse(type = "norm", aes(fill = cluster), geom = "polygon", alpha = 0.2) +
  geom_point(data = centroides, aes(x = clasif_eval, y = depto_ocu),
             color = "black", shape = 17, size = 5) +
  labs(title = "Evaluación médico legal por departamento",
       x = "Tipo de evaluación médico legal", y = "Departamento de ocurrencia") +
  theme_minimal()

```

###### Clústers en servicio médico de necropsias INACIF

```{r}
# Seleccionar variables
campos_cluster <- c("eva_mn", "sexo_per_eva", "g_edad_80ymas", "depto_ocu", "dia_sem_ocu","mes_ocu")
data_fp3 <- datos_fuente3[, campos_cluster]

# Convertir a numérico si faltara
data_fp3[] <- lapply(data_fp3, function(x) {
  if (is.character(x) || is.factor(x)) {
    as.numeric(as.factor(x))
  } else {
    as.numeric(x)
  }
})

# Filtrar valores ignorados y escalar
data_fp3 <- data_fp3 %>%
  filter(eva_mn < 900, depto_ocu < 90) %>%
  na.omit()

data_scaled <- scale(data_fp3)

# Aplicar K-Means con 4 clústeres
set.seed(123)
km_fp3 <- kmeans(data_scaled, centers = 4)
data_fp3$cluster <- factor(km_fp3$cluster)

# Centroides
centroides_fp3 <- as.data.frame(km_fp3$centers)
centroides_fp3$cluster <- factor(1:4)

# Graficar usando eva_mn y departamento_ocu
ggplot(data_fp3, aes(x = eva_mn, y = depto_ocu, color = cluster)) +
  geom_point(alpha = 0.7, size = 3) +
  stat_ellipse(type = "norm", level = 0.95, aes(fill = cluster), geom = "polygon", alpha = 0.2) +
  geom_point(data = centroides_fp3, aes(x = eva_mn, y = depto_ocu),
             color = "black", shape = 17, size = 5, stroke = 1.5) +
  labs(title = "Evaluación médico legal necropcias vs Departamento",
       x = "Tipo de evaluación médico legal", y = "Departamento") +
  theme_minimal()

# Evaluando grupo quinquenal con K-Means de 4 clústeres
set.seed(123)
km_fp3_1 <- kmeans(data_scaled, centers = 4)
data_fp3$cluster <- factor(km_fp3_1$cluster)

# Centroides
centroides_fp3_1 <- as.data.frame(km_fp3_1$centers)
centroides_fp3_1$cluster <- factor(1:4)

# Graficar usando eva_mn y edad
ggplot(data_fp3, aes(x = eva_mn, y = g_edad_80ymas, color = cluster)) +
  geom_point(alpha = 0.7, size = 3) +
  stat_ellipse(type = "norm", level = 0.95, aes(fill = cluster), geom = "polygon", alpha = 0.2) +
  geom_point(data = centroides_fp3, aes(x = eva_mn, y = g_edad_80ymas),
             color = "black", shape = 17, size = 5, stroke = 1.5) +
  labs(title = "Evaluación médico legal necropcias vs Grupo quinquenal",
       x = "Tipo de evaluación médico legal", y = "Grupo quinquenal") +
  theme_minimal()

```

###### Evaluación de clústers por servicio médico de exhumaciones INACIF

```{r}
# Seleccionar variables
campos_cluster <- c("dia_sem_ocu", "depto_ocu", "mes_ocu", "Año", "dia_ocu")
data_num <- datos_fuente4[, campos_cluster]

# Convertir a numérico si es necesario
data_num[] <- lapply(data_num, function(x) {
  if (is.character(x) || is.factor(x)) {
    as.numeric(as.factor(x))
  } else {
    as.numeric(x)
  }
})

# Eliminar NAs y escalar
data_num <- na.omit(data_num)
data_scaled <- scale(data_num)

# Aplicar K-Means con 3 clústeres
set.seed(123)
km <- kmeans(data_scaled, centers = 3)
data_num$cluster <- factor(km$cluster)

# Centroides originales
centroides <- as.data.frame(km$centers)
centroides$cluster <- factor(1:3)

# Graficar usando mes_ocu vs depto_ocu
ggplot(data_num, aes(x = dia_sem_ocu, y = mes_ocu, color = cluster)) +
  geom_point(alpha = 0.7, size = 3) +
  stat_ellipse(type = "norm", level = 0.95, aes(fill = cluster), geom = "polygon", alpha = 0.2) +
  geom_point(data = centroides, aes(x = dia_sem_ocu, y = mes_ocu),
             color = "black", shape = 17, size = 5, stroke = 1.5) +
  labs(title = "Dia de semana vs Mes",
       x = "Día de semana", y = "Mes") +
  theme_minimal()
```

